# malware NOTPETYA

Hi all,

Its the first time i write a small tutorial on a malware; i would like to share with you all the information that i did on the sample of petya that i believe you have already heard a little about that recently.

I analysed the malware and here i provide you the actions of this malware :
- first, check the presence of file having the same name of the payload but without extension.
    For ex:
    if the malware is launched avec an account admin like : rundll32 c:\..\temp\perfc.dat,#168, 
    the malware will check if there is a file "perfc" in the c:\windows, if there is, it stops its execution 
    
    ==>>>>>>>>>>>>>> the kill switch is here :) 
    so the kill switch is the original name of payload but without extension :)
- second, create a scheduled task that will shutdown the computer in nearly one hour
- third, the propagation or infection :
    i provide you the pcap file that logged the traffic passed from an infected machine. you will understand right away how this malware does its propagation :)
  * use psexec/wmi to install and launch the itself on the machine found by using NetServerEnum or GetIpNetTable :) . if it fails, it waits for some minutes before using the 2 exploits Eternalbue and ETERNALROMANCE.
  * at the same time, it scans the local network like "192.168.56.1" "192.168.56.2" .. "192.168.56.255" to find another target:

- third, the encryption :
    * it erase the MBR (master boot record) and overwrite with the code that will be executed once the machine is shutdown :)
    * it replace the file with the specific extensions with the encrypted content without changing the file name :) (AES 128)
    
So, the kill switch is just a check of its presence before launching the attack :) but its an effective counter measure for this malware :)

file is downloaded from here https://github.com/sieutruc/malware/blob/master/README.md

result_folder.txt is the changement of file/folder inside c:\windows if the kill switch is not implemented on the machine to test.
 in this case you see all the files that were created by the malware on the machine to test

result_folder_1.txt is the changement of file/folder inside c:\windows if the kill switch is implemented on the machine to test.
 in this case only the payload is created by the malware and there is no infection :)

here i tested with the payload named pet1.dll :))

have fun with that 
